(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{295:function(t,a,s){"use strict";s.r(a);var e=s(2),r=Object(e.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"nginx语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx语法","aria-hidden":"true"}},[t._v("#")]),t._v(" Nginx语法")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://my.oschina.net/jsan/blog/125861",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx HTTP核心模块指令和内置变量中文说明"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"location-规则匹配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#location-规则匹配","aria-hidden":"true"}},[t._v("#")]),t._v(" location 规则匹配")]),t._v(" "),s("h3",{attrs:{id:"location-语法规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#location-语法规则","aria-hidden":"true"}},[t._v("#")]),t._v(" location 语法规则")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("uri"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ····· \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("location 后接的匹配规则含义")])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("=")]),t._v("   开头表示精确匹配")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("^~")]),t._v("  开头表示uri以某个常规字符串开头，理解为匹配 url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("~")]),t._v("   开头表示区分大小写的正则匹配")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("~*")]),t._v("  开头表示不区分大小写的正则匹配")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("!~")]),t._v("  区分大小写不匹配的正则")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("!~*")]),t._v(" 不区分大小写不匹配的正则")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("/")]),t._v("   通用匹配，任何请求都会匹配到")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[s("code",[t._v("@")]),t._v("   定义一个内部命名的匹配（"),s("a",{attrs:{href:"https://blog.sometimesnaive.org/article/72",target:"_blank",rel:"noopener noreferrer"}},[t._v("等阶于"),s("code",[t._v("internal")]),s("OutboundLink")],1),t._v("），适用于"),s("code",[t._v("error_page")]),t._v(","),s("code",[t._v("try_files")])])])]),t._v(" "),s("h3",{attrs:{id:"当我们有多个-location-配置的情况下，其匹配顺序为："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#当我们有多个-location-配置的情况下，其匹配顺序为：","aria-hidden":"true"}},[t._v("#")]),t._v(" 当我们有多个 location 配置的情况下，其匹配顺序为：")]),t._v(" "),s("blockquote",[s("p",[t._v('首先匹配 "="，其次匹配 "^~", 其次是按文件中顺序的正则匹配，最后是交给 "/" 通用匹配。')])]),t._v(" "),s("blockquote",[s("p",[t._v("当有匹配成功时候，停止匹配，按当前匹配规则处理请求。")])]),t._v(" "),s("h3",{attrs:{id:"比如现在同时存在如下所示匹配规则："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#比如现在同时存在如下所示匹配规则：","aria-hidden":"true"}},[t._v("#")]),t._v(" 比如现在同时存在如下所示匹配规则：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("location = / {\n   #规则A\n}\nlocation = /login {\n   #规则B\n}\nlocation ^~ /static/ {\n   #规则C\n}\nlocation ~ \\.(gif|jpg|png|js|css)$ {\n   #规则D\n}\nlocation ~* \\.png$ {\n   #规则E\n}\nlocation !~ \\.xhtml$ {\n   #规则F\n}\nlocation !~* \\.xhtml$ {\n   #规则G\n}\nlocation / {\n   #规则H\n}\n")])])]),s("h4",{attrs:{id:"那么产生的效果如下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#那么产生的效果如下","aria-hidden":"true"}},[t._v("#")]),t._v(" 那么产生的效果如下")]),t._v(" "),s("blockquote",[s("p",[t._v("访问根目录/   比如 http://localhost/   将匹配规则A")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/login   将匹配规则B，http://localhost/register 则匹配规则H")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/static/a.html   将匹配规则C")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/a.gif, http://localhost/b.jpg   将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用，而 http://localhost/static/c.png 则优先匹配到规则C")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/a.PNG   则匹配规则E，而不会匹配规则D，因为规则E不区分大小写")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/a.xhtml   不会匹配规则F和规则G，http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到")])]),t._v(" "),s("blockquote",[s("p",[t._v("访问 http://localhost/category/id/1111   则最终匹配到规则H，因为以上规则都不匹配，这个时候应该是nginx转发请求给后端应用服务器，比如FastCGI（php），tomcat（jsp），nginx作为方向代理服务器存在")])]),t._v(" "),s("h3",{attrs:{id:"在实际应用中，至少需要有三个匹配规则定义，如下："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在实际应用中，至少需要有三个匹配规则定义，如下：","aria-hidden":"true"}},[t._v("#")]),t._v(" 在实际应用中，至少需要有三个匹配规则定义，如下：")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里是直接转发给后端应用服务器了，也可以是一个静态首页")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 第一个必选规则")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 第二个必选规则是处理静态文件请求，这是 nginx 作为 http 服务器的强项")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("webroot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("static"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" \\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gif"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpeg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("png"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("css"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("js"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("ico"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("webroot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("res"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 第三个规则就是通用规则，用来转发动态请求到后端应用服务器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 非静态文件请求就默认是动态请求，自己根据实际把握")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 毕竟目前的一些框架的流行，带 .php, .jsp 后缀的情况很少了")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("localhost"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"内部调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内部调用","aria-hidden":"true"}},[t._v("#")]),t._v(" 内部调用")]),t._v(" "),s("h4",{attrs:{id:"internal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#internal","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("code",[t._v("internal")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("internal")]),t._v(" 指令用于指定只允许来自本地 "),s("code",[t._v("Nginx")]),t._v(" 的内部调用，来自外部的访问会直接返回 "),s("code",[t._v("404 not found")]),t._v(" 状态。")])]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定义一个内部调用location")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("internal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("internal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".110")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8091")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Real"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Forwarded"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" REMOTE"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("HOST "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解决https->nginx->http->tomcat重定向问题")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_redirect")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\\d"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用rewrite 内部重定向，其中 last 或 break 均可提供内部重定向。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("internal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" last"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 利用 Openresty 的 ngx.exec 模块")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    access_by_lua_block "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ngx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/internal/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"location-name"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#location-name","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("code",[t._v("location @name")])]),t._v(" "),s("blockquote",[s("p",[t._v("命名location中不能再嵌套其它的命名location。")])]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 匹配静态文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("htm"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("html"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("js"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("css"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("png"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("gif"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("eot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("svg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("ttf"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("woff"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("woff2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果文件不存在")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#if (!-f $request_filename) {")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#content_by_lua_block {")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#ngx.exec("@pass");')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wwwroot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 按顺序检查文件是否存在，返回第一个找到的文件。结尾的斜线表示为文件夹 -$uri/。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果所有的文件都找不到，会进行一个内部重定向到最后一个参数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try_files")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" @pass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 通用匹配")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者使用`ngx.exec`主要实现的是内部的重定向")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# `ngx.redirect`是外部重定向")]),t._v("\n    content_by_lua_block "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ngx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@pass"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" @pass "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".110")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8091")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Real"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Forwarded"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" REMOTE"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("HOST "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解决https->nginx->http->tomcat重定向问题")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_redirect")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\\d"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"rewrite-语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rewrite-语法","aria-hidden":"true"}},[t._v("#")]),t._v(" rewrite 语法")]),t._v(" "),s("h4",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://blog.csdn.net/weixin_40792878/article/details/83316519",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("该指令通过正则表达式的使用来改变URI.可以同时存在一个或者多个指令，按照顺序一次对URL进行匹配和处理。\n该指令可以在server块后者location块中配置")])]),t._v(" "),s("h3",{attrs:{id:"语法：rewrite-regex-replacement-flag"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#语法：rewrite-regex-replacement-flag","aria-hidden":"true"}},[t._v("#")]),t._v(" 语法："),s("code",[t._v("rewrite regex replacement [flag];")])]),t._v(" "),s("blockquote",[s("p",[t._v("rewrite是实现URL重定向的重要指令。")]),t._v(" "),s("p",[t._v("regex：用来匹配URI的正则表达式；")]),t._v(" "),s("p",[t._v('replacement：匹配成功后用来替换URI中被截取内容的字符串，默认情况如果该字符串包含“http://”、"https://"开头，\n则不会继续向下对URI进行其他处理。直接返回重写的URI给客户端')]),t._v(" "),s("p",[t._v("flag：用来设置rewrite对URI的处理行为,包含如下数据：")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("标记符号")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("last")]),t._v(" "),s("td",[t._v("终止在本location块中处理接收到的URI，并将此处重写的URI作为新的URI使用其他location进行处理。（只是终止当前location的处理）")])]),t._v(" "),s("tr",[s("td",[t._v("break")]),t._v(" "),s("td",[t._v("将此处重写的URI作为一个新的URI在当前location中继续执行，并不会将新的URI转向其他location。")])]),t._v(" "),s("tr",[s("td",[t._v("redirect")]),t._v(" "),s("td",[t._v("将重写后的URI返回个客户端，状态码是302，表明临时重定向，主要用在replacement字符串不以“http://”，“ https://”或“ $scheme” 开头；")])]),t._v(" "),s("tr",[s("td",[t._v("permanent")]),t._v(" "),s("td",[t._v("将重写的URI返回客户端，状态码为301,指明是永久重定向；")])])])]),t._v(" "),s("h3",{attrs:{id:"可以用来判断的表达式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可以用来判断的表达式","aria-hidden":"true"}},[t._v("#")]),t._v(" 可以用来判断的表达式")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("-f")]),t._v(" 和 "),s("code",[t._v("!-f")]),t._v("    用来判断是否存在文件")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("-d")]),t._v(" 和 "),s("code",[t._v("!-d")]),t._v("    用来判断是否存在目录")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("-e")]),t._v(" 和 "),s("code",[t._v("!-e")]),t._v("    用来判断是否存在文件或目录")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("-x")]),t._v(" 和 "),s("code",[t._v("!-x")]),t._v("    用来判断文件是否可执行")])]),t._v(" "),s("h3",{attrs:{id:"可以用作判断的全局变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可以用作判断的全局变量","aria-hidden":"true"}},[t._v("#")]),t._v(" 可以用作判断的全局变量")]),t._v(" "),s("blockquote",[s("p",[t._v("例：http://localhost:88/test1/test2/test.php")])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$host：localhost")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$server_port：88")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$request_uri：http://localhost:88/test1/test2/test.php")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$document_uri：/test1/test2/test.php")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$document_root：D:\\nginx/html")])])]),t._v(" "),s("blockquote",[s("blockquote",[s("p",[t._v("$request_filename：D:\\nginx/html/test1/test2/test.php")])])]),t._v(" "),s("h2",{attrs:{id:"redirect语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redirect语法","aria-hidden":"true"}},[t._v("#")]),t._v(" Redirect语法")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("igrow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" html"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_host")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" “"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),t._v("star\\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("igrow\\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cn$"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("quot "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("star"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("igrow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cn$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" redirect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"防盗链"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防盗链","aria-hidden":"true"}},[t._v("#")]),t._v(" 防盗链")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("location ~* \\.(gif|jpg|swf)$ {\n    valid_referers none blocked start.igrow.cn sta.igrow.cn;\n    if ($invalid_referer) {\n        rewrite ^/ http://$host/logo.png;\n    }\n}\n")])])]),s("h2",{attrs:{id:"根据文件类型设置过期时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据文件类型设置过期时间","aria-hidden":"true"}},[t._v("#")]),t._v(" 根据文件类型设置过期时间")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" \\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("css"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jpeg"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("gif"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("png"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("swf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_filename")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("expires")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("h"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"禁止访问某个目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#禁止访问某个目录","aria-hidden":"true"}},[t._v("#")]),t._v(" 禁止访问某个目录")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" \\"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("txt"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("doc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("wwwroot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("linuxtone"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("deny")]),t._v(" all"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"可用的全局变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可用的全局变量","aria-hidden":"true"}},[t._v("#")]),t._v(" 可用的全局变量")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("$args")]),t._v(" 这个变量等于请求行中(GET请求)的参数，同"),s("code",[t._v("$query_string")])]),t._v(" "),s("p",[s("code",[t._v("$is_args")]),t._v(' 如果已经设置$args，则该变量的值为"？"，否则为""。')]),t._v(" "),s("p",[s("code",[t._v("$content_length")]),t._v(" 请求头中的Content-length字段。")]),t._v(" "),s("p",[s("code",[t._v("$content_type")]),t._v(" 请求头中的Content-Type字段。")]),t._v(" "),s("p",[s("code",[t._v("$document_root")]),t._v(" 当前请求在root指令中指定的值。")]),t._v(" "),s("p",[s("code",[t._v("$document_uri")]),t._v(" 与"),s("code",[t._v("$uri")]),t._v("相同。")]),t._v(" "),s("p",[s("code",[t._v("$host")]),t._v(" 请求主机头字段，否则为服务器名称。")]),t._v(" "),s("p",[s("code",[t._v("$http_user_agent")]),t._v(" 客户端agent信息")]),t._v(" "),s("p",[s("code",[t._v("$http_cookie")]),t._v(" 客户端cookie信息")]),t._v(" "),s("p",[s("code",[t._v("$limit_rate")]),t._v(" 这个变量可以限制连接速率。")]),t._v(" "),s("p",[s("code",[t._v("$request_body_file")]),t._v(" 客户端请求主体信息的临时文件名。")]),t._v(" "),s("p",[s("code",[t._v("$request_method")]),t._v(" 客户端请求的动作，通常为GET或POST。")]),t._v(" "),s("p",[s("code",[t._v("$remote_addr")]),t._v(" 客户端的IP地址。")]),t._v(" "),s("p",[s("code",[t._v("$remote_port")]),t._v(" 客户端的端口。")]),t._v(" "),s("p",[s("code",[t._v("$remote_user")]),t._v(" 已经经过Auth Basic Module验证的用户名。")]),t._v(" "),s("p",[s("code",[t._v("$request_filename")]),t._v(" 当前请求的文件路径，由root或alias指令与URI请求生成。")]),t._v(" "),s("p",[s("code",[t._v("$request_uri")]),t._v('  包含请求参数的原始URI，不包含主机名，如："/?dir=DeveloperTool"。')]),t._v(" "),s("p",[s("code",[t._v("$query_string")]),t._v(" 这个变量等于请求行中的参数，同"),s("code",[t._v("$args")])]),t._v(" "),s("p",[s("code",[t._v("$scheme")]),t._v(" HTTP协议（如http，https）。")]),t._v(" "),s("p",[s("code",[t._v("$server_protocol")]),t._v(" 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。")]),t._v(" "),s("p",[s("code",[t._v("$server_addr")]),t._v(" 服务器地址，在完成一次系统调用后可以确定这个值。")]),t._v(" "),s("p",[s("code",[t._v("$server_name")]),t._v(" 服务器名称。")]),t._v(" "),s("p",[s("code",[t._v("$server_port")]),t._v(" 请求到达服务器的端口号。")]),t._v(" "),s("p",[s("code",[t._v("$uri")]),t._v(" 不带请求参数的当前URI， uri不包含主机名")])]),t._v(" "),s("h2",{attrs:{id:"判断user-agent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#判断user-agent","aria-hidden":"true"}},[t._v("#")]),t._v(" 判断"),s("code",[t._v("user_agent")])]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 判断是否为移动端访问")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_user_agent")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重写URI作为一个新的URI在当前location中继续执行。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 目的是在if块中proxy_pass不能带URI")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("^")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("URI参数$"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("https")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#proxy_set_header Host $host;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Real"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Forwarded"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" REMOTE"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("HOST "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"proxy-pass指令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#proxy-pass指令","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("code",[t._v("proxy_pass")]),t._v("指令")]),t._v(" "),s("blockquote",[s("p",[t._v("nginx无法在proxy_pass指令中处理所需的URI部分，因为位于指定的位置（因此是错误消息）。\n这是因为nginx是以模块化的方式构建的，每个配置块都是由各个模块在各个阶段读取的。\n所以请记住，proxy_pass在以下情况下，指令中不能有URI ：")]),t._v(" "),s("blockquote",[s("p",[t._v("正则表达式位置")]),t._v(" "),s("p",[t._v("命名的地点")]),t._v(" "),s("p",[t._v("if 块")])])]),t._v(" "),s("h3",{attrs:{id:"解决方案可见判断user-agent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方案可见判断user-agent","aria-hidden":"true"}},[t._v("#")]),t._v(" 解决方案可见"),s("a",{attrs:{href:"#%E5%88%A4%E6%96%ADuser-agent"}},[t._v("判断"),s("code",[t._v("user_agent")])])])])},[],!1,null,null,null);a.default=r.exports}}]);